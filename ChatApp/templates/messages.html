{% extends 'util/base.html' %} {% block title %}
<title>メッセージ</title>
{% endblock title %} {% block content %}

<body class="body">
  <!-- ヘッダー -->
  <header class="header">
    <h1>{{ chat.chat_name }}</h1>
    <form action="/chats" method="GET" class="back-button">
      <input type="image" src="{{ url_for('static', filename='img/left.png') }}" alt="戻る" class="header-image" />
    </form>

    {% if chat.chat_type == 2 %}
    <a onclick="openModal()" class="deletebox-button">
      <input type="image" src="{{ url_for('static', filename='img/delete.png') }}" alt="削除" class="header-image" />
    </a>
    {% else %}
    <form action="/chat/{{ chat.id }}/detail" method="GET" class="setting-button">
      <input type="image" src="{{ url_for('static', filename='img/setting.png') }}" alt="編集" class="header-image" />
    </form>
    {% endif %}
  </header>

  <!-- メイン -->
  <main class="messages">
    {% for message in messages %}
    <div class="message {{ 'right' if message.user_id == user_id else 'left' }}">
      {% if message.user_id != user_id %}
      <div class="message-header">
        <img src="{{ url_for('static', filename='img/user_icons/' ~ message.icon_img) }}" alt="ユーザーアイコン"
          class="message-icon" />
        <span class="user-name">{{ message.user_name }}</span>
      </div>
      {% endif %}

      <div class="message-box-wrapper">
        <div class="message-box">
          {% if message.message %}
          <div class="message-text">{{ message.message }}</div>
          {% elif message.stamp_path %}
          <div class="message-stamp">
            <img src="{{ url_for('static', filename=message.stamp_path) }}" alt="stamp" />
          </div>
          {% endif %}
        </div>

        {% if message.user_id == user_id %}
        <button class="slide-delete-btn hidden" data-message-id="{{ message.id }}">削除</button>
        <form action="/chat/{{ chat.id }}/messages/{{ message.id }}" method="POST" class="delete-form hidden"></form>
        {% endif %}
      </div>

      <div class="message-time-box {{ 'right' if message.user_id == user_id else 'left' }}">
        <span class="message-time">{{ message.created_at }}</span>
      </div>
    </div>
    {% endfor %}
  </main>

  <!-- フッター -->
  <footer class="chat-screen">
    <form id="chatInputForm" action="/chat/{{ chat.id }}/messages" method="POST" class="chat-form">
      <div class="input-wrapper">
        <textarea id="footer-message" name="message" placeholder="メッセージを入力"></textarea>
        <button id="stampToggle" class="stamp-button" type="button">
          <img src="../../static/img/stamp-button.png" class="title-logo" />
        </button>
        <input type="image" src="{{ url_for('static', filename='img/send-button.png') }}" alt="送信"
          class="send-button" />
      </div>
    </form>

    <div id="stampList" class="stamp-list hidden">
      {% for stamp in stamps %}
      <img src="{{ url_for('static', filename=stamp.stamp_path) }}" data-stamp-id="{{ stamp.id }}" class="stamp-item"
        alt="stamp" />
      {% endfor %}
      <button id="stampClose" class="stamp-close" type="button">
        <img src="{{ url_for('static', filename='img/stamp-close.png') }}" class="stamp-close-button" />
      </button>
    </div>

    <form id="stampForm" action="/chat/{{ chat.id }}/messages" method="POST">
      <input type="hidden" name="stamp" id="stampInput" />
    </form>
  </footer>

  <!-- モーダル -->
  <!-- チャット削除用フォーム -->
  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <img src="{{ url_for('static', filename='img/chat-delete.png') }}" class="js-logout-img" alt="注意" />
      <div class="font">チャット削除しますか？</div>
      <!-- チャット削除用フォーム -->

      <form action="/chat/delete/private/{{ chat.id }}" method="POST">
        <input type="submit" class="js-btn delete" value="はい" />
      </form>

      <!-- キャンセルボタン -->
      <button class="js-btn cancel" onclick="closeModal()">キャンセル</button>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const messagesContainer = document.querySelector('main.messages');
      const chatInputForm = document.getElementById('chatInputForm');

      // ------------------------
      // スクロール関数
      // ------------------------
      function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // 初期表示でスクロール
      scrollToBottom();

      // ------------------------
      // メッセージ時間の変換
      // ------------------------
      function formatMessageTime() {
        document.querySelectorAll('.message-time').forEach(span => {
          const dateStr = span.textContent.trim();
          if (dateStr) {
            const utcStr = dateStr.replace(" ", "T") + "Z";
            const date = new Date(utcStr);
            if (!isNaN(date.getTime())) {
              const hours = String((date.getUTCHours() + 9) % 24).padStart(2, '0');
              const minutes = String(date.getUTCMinutes()).padStart(2, '0');
              span.textContent = `${hours}:${minutes}`;
            }
          }
        });
      }
      formatMessageTime();

      // ------------------------
      // 削除ボタン設定
      // ------------------------
      function setupDeleteButtons() {
        const userMessages = document.querySelectorAll(".message.right");
        userMessages.forEach((msg) => {
          const deleteBtn = msg.querySelector(".slide-delete-btn");
          const deleteForm = msg.querySelector(".delete-form");

          if (!deleteBtn) return;

          msg.addEventListener("click", function (e) {
            e.stopPropagation();
            document.querySelectorAll(".slide-delete-btn").forEach((btn) => {
              if (btn !== deleteBtn) btn.classList.add("hidden");
              if (btn !== deleteBtn) btn.parentElement.querySelector(".message-box").style.transform = "translateX(0)";
            });
            deleteBtn.classList.toggle("hidden");
            msg.querySelector(".message-box").style.transform = deleteBtn.classList.contains("hidden") ? "translateX(0)" : "translateX(-50px)";
          });

          deleteBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            fetch(deleteForm.action, { method: "POST", headers: { "X-Requested-With": "XMLHttpRequest" }, body: "" })
              .then(res => { if (res.ok) msg.remove(); else alert("削除に失敗しました。"); })
              .catch(err => { console.error(err); alert("削除中にエラーが発生しました。"); });
          });
        });

        document.addEventListener("click", function () {
          userMessages.forEach((msg) => {
            const btn = msg.querySelector(".slide-delete-btn");
            if (btn && !btn.classList.contains("hidden")) {
              btn.classList.add("hidden");
              msg.querySelector(".message-box").style.transform = "translateX(0)";
            }
          });
        });
      }
      setupDeleteButtons();

      // ------------------------
      // スタンプ設定
      // ------------------------
      const stampToggle = document.getElementById("stampToggle");
      const stampClose = document.getElementById("stampClose");
      const stampList = document.getElementById("stampList");
      const stamps = document.querySelectorAll(".stamp-item");

      stampToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        stampList.classList.toggle("hidden");
        chatInputForm.style.display = stampList.classList.contains("hidden") ? "flex" : "none";
      });

      stampClose.addEventListener("click", (e) => {
        e.stopPropagation();
        stampList.classList.add("hidden");
        chatInputForm.style.display = "flex";
      });

      stamps.forEach(stamp => {
        stamp.addEventListener("click", (e) => {
          e.stopPropagation();
          document.getElementById('stampInput').value = stamp.dataset.stampId;
          document.getElementById('stampForm').submit();
          stampList.classList.add("hidden");
          chatInputForm.style.display = "flex";
        });
      });

      document.addEventListener("click", (e) => {
        if (!stampList.contains(e.target) && e.target !== stampToggle) {
          stampList.classList.add("hidden");
          chatInputForm.style.display = "flex";
        }
      });

      // ------------------------
      // ページ読み込み後に下スクロール
      // ------------------------
      window.scrollTo(0, messagesContainer.scrollHeight);

    });

    // ------------------------
    // モーダル制御
    // ------------------------
    function openModal() { document.getElementById("myModal").style.display = "flex"; }
    function closeModal() { document.getElementById("myModal").style.display = "none"; }
  </script>





  <!-- CSS -->
  <style>
    .message {
      display: flex;
      flex-direction: column;
      margin: 8px 12px;
      position: relative;
    }

    .message.right {
      align-items: flex-end;
      cursor: pointer;
    }

    .message.left {
      align-items: flex-start;
    }

    .message-box-wrapper {
      display: flex;
      align-items: center;
      position: relative;
    }

    .message-box {
      padding: 10px 12px;
      border-radius: 10px;
      background-color: #ffdcdc;
      max-width: 60%;
      word-wrap: break-word;
      transition: transform 0.3s;
    }

    .message-text {
      font-size: 14px;
    }

    .message-stamp img {
      width: 80px;
      height: 80px;
    }

    .slide-delete-btn {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      background-color: #ff5c5c;
      border: none;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .slide-delete-btn.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .message-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .user-name {
      font-weight: bold;
      font-size: 14px;
      color: #ff9494;
    }

    .message-time {
      font-size: 12px;
      color: #888;
    }

    /* スタンプやフッターは従来通り */
    .stamp-list.hidden {
      display: none;
    }

    .stamp-list {
      position: absolute;
      bottom: 1px;
      background: #ff9494;
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(3, 70px);
      gap: 50px;
      justify-content: center;
      z-index: 100;
      width: 100%;
    }

    .stamp-item {
      width: 80px;
      height: 80px;
      cursor: pointer;
    }

    .stamp-item:hover {
      transform: scale(1.2);
    }

    .stamp-button {
      position: absolute;
      right: 60px;
      top: 5px;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }

    .stamp-button img {
      width: 20px;
      height: 20px;
    }

    .stamp-close {
      background: none;
      border: none;
      cursor: pointer;
    }

    .stamp-close img {
      width: 37.33px;
      height: 37.33px;
      position: absolute;
      bottom: 10px;
      right: 100px;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
    }
  </style>
</body>
{% endblock content %}